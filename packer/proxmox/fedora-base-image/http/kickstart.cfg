# Fedora Server 43 Kickstart Configuration
# Automated installation for Ansible-ready Proxmox VM templates

# Installation mode
text
reboot
firstboot --disable
skipx

# Language and keyboard
lang en_US.UTF-8
keyboard us

# Timezone
timezone America/New_York --utc

# Network configuration (device-agnostic)
network --bootproto=dhcp --device=link --activate --onboot=on --ipv6=auto
network --hostname=fedora-template

# Root password (disabled - use SSH key auth only)
rootpw --lock

# Firewall: allow SSH
firewall --enabled --service=ssh

# Disk configuration
zerombr
clearpart --all --initlabel
autopart --type=lvm

# Installation source
cdrom

# Package selection (Fedora 43 stable groups)
%packages --ignoremissing --excludedocs
@core
openssh-server
sudo
python3
python3-libselinux
curl
qemu-guest-agent
%end

# Enable kdump (optional; keep if you want parity with older builds)
%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

# User configuration - automation user for Ansible
# NOTE: Do NOT lock this user; Packer will SSH in using the authorized_keys we install in %post.
user --name=a_autoprov --gecos="Automation User" --groups=wheel --shell=/bin/bash

# Post-installation script
%post --log=/root/ks-post.log

set -euxo pipefail

# Ensure services are enabled AND started
systemctl enable --now sshd || true
systemctl enable --now qemu-guest-agent || true

# Create SSH directory with correct perms/ownership
install -d -m 0700 -o a_autoprov -g a_autoprov /home/a_autoprov/.ssh

# Fetch SSH key from artifact server
curl --connect-timeout 5 --max-time 15 -fsSL \
  "http://artifacts.dvntm.deevnet.net/keys/ssh/a_autoprov_rsa.pub" \
  -o /home/a_autoprov/.ssh/authorized_keys || true

# Enforce perms/ownership
chmod 0600 /home/a_autoprov/.ssh/authorized_keys || true
chown -R a_autoprov:a_autoprov /home/a_autoprov/.ssh

# Fix SELinux contexts so sshd will accept the key
restorecon -Rv /home/a_autoprov/.ssh || true

# Passwordless sudo for automation user
cat >/etc/sudoers.d/010_a_autoprov-nopasswd <<'EOF'
a_autoprov ALL=(ALL) NOPASSWD: ALL
EOF
chmod 0440 /etc/sudoers.d/010_a_autoprov-nopasswd
restorecon /etc/sudoers.d/010_a_autoprov-nopasswd || true

%end
