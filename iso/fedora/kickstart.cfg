# Fedora Server 43 Kickstart Configuration
# Automated installation for Ansible-ready VM templates

# Installation mode
text
reboot

# Language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network configuration
network --bootproto=dhcp --device=link --activate --onboot=on
network --hostname=fedora-template

# Root password (disabled - use SSH key auth only)
rootpw --lock

# User configuration - automation user for Ansible
user --name=a_autoprov --groups=wheel --shell=/bin/bash

# Disk configuration
clearpart --all --initlabel
autopart --type=lvm

# Package selection
%packages
@^minimal-environment
python3
sudo
openssh-server
curl
%end

# Post-installation script
%post --log=/root/ks-post.log

# Configure SSH for automation user
mkdir -p /home/a_autoprov/.ssh
chmod 700 /home/a_autoprov/.ssh

# Fetch SSH public key from artifact server
# Note: Adjust URL if artifact server is not available during install
curl -fsSL http://localhost/keys/ssh/a_autoprov_rsa.pub > /home/a_autoprov/.ssh/authorized_keys 2>/dev/null || \
  echo "# SSH key will be added post-install" > /home/a_autoprov/.ssh/authorized_keys

chmod 600 /home/a_autoprov/.ssh/authorized_keys
chown -R a_autoprov:a_autoprov /home/a_autoprov/.ssh

# Configure passwordless sudo for automation user
echo 'a_autoprov ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/010_a_autoprov-nopasswd
chmod 440 /etc/sudoers.d/010_a_autoprov-nopasswd

# Enable SSH service
systemctl enable sshd

# Enable QEMU guest agent for Proxmox integration
systemctl enable qemu-guest-agent

%end
