---
# Raspberry Pi SDR Image Provisioning Playbook (OFFLINE)
#
# This playbook is intended to run against a mounted Raspberry Pi OS image,
# where the root filesystem is mounted at chroot_root (e.g., /mnt/pi-bookworm-image).
#
# It does NOT require the image to boot or have networking.
#
# Usage (from Makefile):
#   sudo ansible-playbook -i ansible/inventory/chroot.ini ansible/pi-sdr-config.yml \
#     --extra-vars "chroot_root=/mnt/pi-bookworm-image"

- name: Configure Pi SDR Image (offline)
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # REQUIRED: passed in from Makefile
    chroot_root: "{{ chroot_root | default(omit) }}"

    # Image identity
    image_name: "pi-sdr-bookworm"

    # Common file paths inside the image
    boot_config_txt: "{{ chroot_root }}/boot/config.txt"
    boot_cmdline_txt: "{{ chroot_root }}/boot/cmdline.txt"
    marker_file: "{{ chroot_root }}/etc/packer-provisioned"

    # Enable these by default for SDR/HAT work
    enable_spi: true
    enable_i2c: true
    enable_uart: true

    # If you want SSH enabled on first boot
    enable_ssh: true

  pre_tasks:
    - name: Assert chroot_root provided
      ansible.builtin.assert:
        that:
          - chroot_root is defined
          - chroot_root | length > 1
        fail_msg: >
          chroot_root must be set (e.g. --extra-vars "chroot_root=/mnt/pi-bookworm-image")

    - name: Assert we look like a mounted rootfs
      ansible.builtin.stat:
        path: "{{ chroot_root }}/etc/os-release"
      register: osrel

    - name: Fail if mounted rootfs not found
      ansible.builtin.assert:
        that:
          - osrel.stat.exists
        fail_msg: "No /etc/os-release at {{ chroot_root }} â€” is the image mounted?"

    - name: Ensure required directories exist in image
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ chroot_root }}/etc"
        - "{{ chroot_root }}/etc/systemd/system/multi-user.target.wants"
        - "{{ chroot_root }}/boot"

  tasks:
    - name: Verify Ansible is running and show host + image paths
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Configuring mounted image at: {{ chroot_root }}"
          - "Boot config: {{ boot_config_txt }}"

    - name: Create marker file to verify provisioning
      ansible.builtin.copy:
        dest: "{{ marker_file }}"
        content: |
          Image: {{ image_name }}
          Build Date: {{ ansible_date_time.iso8601 }}
          Ansible Version: {{ ansible_version.full }}
        mode: "0644"
        owner: root
        group: root

    # ------------------------------------------------------------
    # SSH enablement
    # ------------------------------------------------------------
    - name: Ensure SSH is enabled on first boot (Raspberry Pi OS boot flag)
      when: enable_ssh
      ansible.builtin.file:
        path: "{{ chroot_root }}/boot/ssh"
        state: touch
        mode: "0644"

    - name: Check if ssh.service unit exists in image (/lib)
      when: enable_ssh
      ansible.builtin.stat:
        path: "{{ chroot_root }}/lib/systemd/system/ssh.service"
      register: ssh_unit_lib

    - name: Check if ssh.service unit exists in image (/usr/lib)
      when: enable_ssh
      ansible.builtin.stat:
        path: "{{ chroot_root }}/usr/lib/systemd/system/ssh.service"
      register: ssh_unit_usr_lib

    - name: Enable ssh.service by creating symlink (only if unit exists)
      when:
        - enable_ssh
        - (ssh_unit_lib.stat.exists | default(false)) or (ssh_unit_usr_lib.stat.exists | default(false))
      ansible.builtin.file:
        # IMPORTANT: this is the target path AS SEEN INSIDE THE IMAGE when it boots
        src: >-
          {{ (ssh_unit_lib.stat.exists | default(false))
              | ternary('/lib/systemd/system/ssh.service', '/usr/lib/systemd/system/ssh.service') }}
        dest: "{{ chroot_root }}/etc/systemd/system/multi-user.target.wants/ssh.service"
        state: link
        force: true

    # ------------------------------------------------------------
    # Boot configuration for HAT / SDR prerequisites
    # ------------------------------------------------------------
    - name: Ensure /boot/config.txt exists
      ansible.builtin.file:
        path: "{{ boot_config_txt }}"
        state: touch
        mode: "0644"

    - name: Enable SPI in /boot/config.txt
      when: enable_spi
      ansible.builtin.lineinfile:
        path: "{{ boot_config_txt }}"
        regexp: '^dtparam=spi='
        line: 'dtparam=spi=on'
        insertafter: EOF

    - name: Enable I2C in /boot/config.txt
      when: enable_i2c
      ansible.builtin.lineinfile:
        path: "{{ boot_config_txt }}"
        regexp: '^dtparam=i2c_arm='
        line: 'dtparam=i2c_arm=on'
        insertafter: EOF

    - name: Enable UART in /boot/config.txt
      when: enable_uart
      ansible.builtin.lineinfile:
        path: "{{ boot_config_txt }}"
        regexp: '^enable_uart='
        line: 'enable_uart=1'
        insertafter: EOF

    # Optional: commonly needed for some HAT overlays
    # Keep disabled until you know you need it.
    # - name: Ensure dtparam=audio=off (free PWM pins / avoid conflicts)
    #   ansible.builtin.lineinfile:
    #     path: "{{ boot_config_txt }}"
    #     regexp: '^dtparam=audio='
    #     line: 'dtparam=audio=off'
    #     insertafter: EOF

    # ------------------------------------------------------------
    # CaribouLite / SDR stack hook points
    # ------------------------------------------------------------
    - name: Create directory for image-baked assets
      ansible.builtin.file:
        path: "{{ chroot_root }}/opt/deevnet"
        state: directory
        mode: "0755"

    - name: Drop a placeholder README for SDR baked image
      ansible.builtin.copy:
        dest: "{{ chroot_root }}/opt/deevnet/README-sdr.txt"
        mode: "0644"
        content: |
          Deevnet Pi SDR Image (Bookworm)
          =================================
          This image was baked offline.
          Next steps:
            - Add CaribouLite driver install steps
            - Add required dt overlays
            - Add SDR userspace tooling (SoapySDR, gnuradio, etc.)

    # ------------------------------------------------------------
    # Optional: run commands inside the image via chroot
    # Use this for apt installs *if* your offline chroot has network.
    # If not, keep it disabled and do only file-based configuration.
    # ------------------------------------------------------------
    - name: OPTIONAL - verify apt is present in chroot
      ansible.builtin.stat:
        path: "{{ chroot_root }}/usr/bin/apt-get"
      register: aptget_stat

    - name: OPTIONAL - update apt cache inside chroot (requires working DNS/network for host)
      when: false  # flip to true if you want chroot package installs and your host network/DNS is good
      ansible.builtin.command:
        cmd: "chroot {{ chroot_root }} /usr/bin/apt-get update"
      changed_when: true

    - name: OPTIONAL - install baseline SDR packages inside chroot
      when: false  # flip to true when ready
      ansible.builtin.command:
        cmd: >
          chroot {{ chroot_root }} /usr/bin/apt-get install -y
          git
          curl
          ca-certificates
          build-essential
      changed_when: true
